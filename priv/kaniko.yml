apiVersion: v1
kind: Pod
metadata:
  name: kaniko
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    args: ["--dockerfile=/workspace/dockerfile",
            "--context=dir://workspace",
            "--destination=k8s-registry:5000/test-kaniko3",
            "--registry-mirror=k8s-registry:5000",
            "--skip-tls-verify=true",
            "--registry-certificate=k8s-registry=/certs/registry.crt"]

    volumeMounts:
      - name: dockerfile-storage
        mountPath: /workspace
      - name: certs-vol
        mountPath: /certs
  restartPolicy: Never
  volumes:
    - name: dockerfile-storage
      persistentVolumeClaim:
        claimName: dockerfile-claim
    - name: certs-vol
      hostPath:
        path: /opt/certs
        type: Directory

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: dockerfile
  labels:
    type: local
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  storageClassName: local-storage
  hostPath:
    path: "/home/docker/kaniko"

---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: dockerfile-claim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 8Gi
  storageClassName: local-storage